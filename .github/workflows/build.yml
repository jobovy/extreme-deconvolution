name: build

on:
  push:
  pull_request:
  schedule:
    - cron: '0 20 * * 2'
    
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.7,3.8,3.9,"3.10"]
    env:
      PYTHON_COVREPORTS_VERSION: 3.9
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install the GSL
      run: sudo apt-get install libgsl-dev        
    - name: Install lcov
      run: |
         wget http://downloads.sourceforge.net/ltp/lcov-1.14.tar.gz
         tar xf lcov-1.14.tar.gz
         sudo make -C lcov-1.14/ install
    - name: Install Python dependencies
      run: pip install --upgrade --upgrade-strategy eager numpy scipy matplotlib setuptools
    - name: Install package
      env:
        CFLAGS: -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC
      run: |
        make COVERAGE=1
        make install INSTALL_DIR=/home/runner/work/extreme-deconvolution/extreme-deconvolution/src/
        make pywrapper INSTALL_DIR=/home/runner/work/extreme-deconvolution/extreme-deconvolution/src/
        mv py spy # py gives difficulty
        echo "PYTHONPATH=$(echo $PYTHONPATH:$PWD/spy)" >> $GITHUB_ENV
    - name: Test with pytest
      run: |
        pip install pytest pytest-cov
        pytest -v tests/test_oned.py tests/test_twod.py tests/test_fix.py tests/test_log.py --cov=extreme_deconvolution --cov-config .coveragerc_travis --cov-report=term --cov-report=xml
    - name: Generate code coverage
      if: ${{ matrix.python-version == env.PYTHON_COVREPORTS_VERSION }} 
      run: |
        ls src
        lcov --capture --base-directory . --directory src/ --no-external --output-file coverage.info
    - name: Upload coverage reports to codecov
      if: ${{ matrix.python-version == env.PYTHON_COVREPORTS_VERSION }}
      uses: codecov/codecov-action@v2
